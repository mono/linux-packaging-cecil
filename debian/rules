#!/usr/bin/make -f
# -*- makefile -*-

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

# This is for the .wapi directory for Mono.
export MONO_SHARED_DIR=$(CURDIR)

# provide patch and unpatch targets
include /usr/share/dpatch/dpatch.make

CFLAGS = -Wall -g

ifneq (,$(findstring noopt,$(DEB_BUILD_OPTIONS)))
	CFLAGS += -O0
else
	CFLAGS += -O2
endif

UPVERSION = $(shell dpkg-parsechangelog | grep ^Vers | cut -d\  -f2 | sed 's,-.*,,')
ABIVERSION = 0.5

build: patch-stamp build-stamp
build-stamp:
	uudecode -o debian/mono.snk debian/mono.snk.uue

	# build Mono.Cecil.dll
	cd Mono.Cecil && mcs -keyfile:../debian/mono.snk \
		@Mono.Cecil.dll.sources /target:library \
		/out:Mono.Cecil.dll
	sed -e 's;@prefix@;/usr;g' \
		-e 's;^Version:.*;Version:\ $(UPVERSION);g' \
		-e 's;^assemblies_dir=.*;assemblies_dir=$${prefix}/lib/cli/mono-cecil-$(ABIVERSION);g' \
		Mono.Cecil/mono-cecil.pc.in > Mono.Cecil/mono-cecil.pc

	# build Mono.Cecil.Mdb.dll, needs newer mono!
	# cd Mono.Cecil.Mdb && mcs -keyfile:../debian/mono.snk \
	#	@Mono.Cecil.Mdb.dll.sources /target:library \
	#	/r:../Mono.Cecil/Mono.Cecil.dll \
	#	/r:Mono.CompilerServices.SymbolWriter.dll
	#	/out:Mono.Cecil.Mdb.dll	


#	cd debian && al -link:policy.0.5.Mono.Cecil.config \
                    -out:policy.0.5.Mono.Cecil.dll \
                    -keyfile:mono.snk

	touch build-stamp

clean: unpatch
	dh_testdir
	dh_testroot
	-$(MAKE) clean
	rm -f debian/policy.0.5.Mono.Cecil.dll
	rm -rf $(MONO_SHARED_DIR)/.wapi
	rm -f patch-stamp build-stamp debian/mono.snk
	rm -f config.make

	rm -f Mono.Cecil/Mono.Cecil.dll
	rm -f Mono.Cecil/mono-cecil.pc
	rm -f Mono.Cecil.Mdb/Mono.Cecil.Mdb.dll

	dh_clean 

install: build
	dh_testdir
	dh_testroot
	dh_clean -k
	
binary-indep: patch build install
	dh_testdir
	dh_testroot
	dh_installdirs

	dh_install

	dh_installchangelogs Mono.Cecil/ChangeLog
	dh_installdocs
	dh_installman
	dh_installcligac
	
	dh_compress
	dh_fixperms
	dh_clifixperms
	dh_clistrip
	dh_makeclilibs -m $(UPVERSION)
	dh_clideps -d
	dh_installdeb
	dh_gencontrol
	dh_md5sums
	dh_builddeb

binary-arch: build install

binary: binary-indep binary-arch

.PHONY: patch build clean binary-indep binary-arch binary install 
