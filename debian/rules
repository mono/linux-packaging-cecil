#!/usr/bin/make -f
# -*- makefile -*-

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

include /usr/share/cli-common/cli.make

# provide patch and unpatch targets
include /usr/share/dpatch/dpatch.make

UPVERSION = $(shell dpkg-parsechangelog | grep ^Vers | cut -d\  -f2 | sed 's,-.*,,')
ABIVERSION = 0.5

build: build-stamp
build-stamp: $(DPATCH_STAMPFN)
	uudecode -o debian/mono.snk debian/mono.snk.uue
	dh build --before dh_auto_build

	# build Mono.Cecil.dll
	cd Mono.Cecil && csc -keyfile:../debian/mono.snk \
		@Mono.Cecil.dll.sources /target:library \
		/out:Mono.Cecil.dll
	sed -e 's;@prefix@;/usr;g' \
		-e 's;^Version:.*;Version:\ $(UPVERSION);g' \
		-e 's;^assemblies_dir=.*;assemblies_dir=$${prefix}/lib/cli/mono-cecil-$(ABIVERSION);g' \
		Mono.Cecil/mono-cecil.pc.in > Mono.Cecil/mono-cecil.pc

	# build Mono.Cecil.Mdb.dll, needs newer mono!
	# cd Mono.Cecil.Mdb && csc -keyfile:../debian/mono.snk \
	#	@Mono.Cecil.Mdb.dll.sources /target:library \
	#	/r:../Mono.Cecil/Mono.Cecil.dll \
	#	/r:Mono.CompilerServices.SymbolWriter.dll
	#	/out:Mono.Cecil.Mdb.dll	


#	cd debian && al -link:policy.0.5.Mono.Cecil.config \
                    -out:policy.0.5.Mono.Cecil.dll \
                    -keyfile:mono.snk

	dh build --after dh_auto_build
	touch $@

clean: unpatch
	dh $@ --before dh_clean
	dh_clean debian/policy.0.5.Mono.Cecil.dll debian/mono.snk config.make \
		Mono.Cecil/Mono.Cecil.dll Mono.Cecil/mono-cecil.pc Mono.Cecil.Mdb/Mono.Cecil.Mdb.dll

install: install-stamp
install-stamp: build
	dh install --before dh_installchangelogs
	dh_installchangelogs Mono.Cecil/ChangeLog
	dh install --after dh_installchangelogs

binary-indep: install
	dh $@ --before dh_makeclilibs
	dh_makeclilibs -m $(UPVERSION)
	dh_clideps -d
	dh $@ --remaining

binary-arch:

binary: binary-indep binary-arch

.PHONY: build clean binary-indep binary-arch binary install 
